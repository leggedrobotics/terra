# Terra Isaac Sim

This ROS 2 package provides a node that executes navigation plans extracted from the Terra simulation environment using Nav2.

## Overview

The `nav2_plan_executor` node reads a plan file (`.pkl`) generated by `extract_plan.py` and executes it by sending sequential navigation goals to Nav2. The robot will navigate to each waypoint in the plan and wait for the goal to be reached before proceeding to the next one.

## Dependencies

Make sure you have the following ROS 2 packages installed:

```bash
sudo apt install ros-humble-nav2-bringup ros-humble-tf-transformations
```

Python dependencies:
```bash
pip install tf-transformations
```

## Building

1. Create or navigate to your ROS 2 workspace:
```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src
```

2. Copy this package to your workspace src directory, then build:
```bash
cd ~/ros2_ws
colcon build --packages-select terra_nav
source install/setup.bash
```

## Usage

1. First, generate a plan using `extract_plan.py`:
```bash
python extract_plan.py -policy path/to/policy.pkl -map path/to/map -o my_plan.pkl
```

2. Run `moleworks_ext` navigation standalone:
```bash
# TODO
```

3. Run the `moleworks_ext` navigation stack:
```bash
# TODO
```

4. Run the plan executor:
```bash
ros2 launch terra_nav nav2_plan_executor.launch.py plan_path:=path/to/your/plan.pkl frame_id:=map
```

## Parameters

- `plan_path` (required): Path to the .pkl file containing the extracted plan
- `frame_id` (optional): Frame ID for navigation goals (default: "map")

## Plan File Format

The plan file should be a pickle file containing a list of dictionaries with the following structure:

```python
[
    {
        'step': int,                    # Timestep when DO action occurred
        'action_map': np.array,         # Action map from environment
        'agent_state': {
            'pos_base': (float, float), # Robot position (x, y)
            'angle_base': float,        # Robot orientation in radians
            'wheel_angle': float,       # Wheel angle
            'loaded': bool,             # Whether robot is loaded
        }
    },
    # ... more waypoints
]
```

## How It Works

1. The node loads the plan from the specified pickle file
2. It creates an action client for Nav2's `NavigateToPose` action
3. For each waypoint in the plan:
   - Creates a `PoseStamped` goal from the agent's position and orientation
   - Sends the goal to Nav2
   - Waits for the goal to be reached
   - Proceeds to the next waypoint
4. Logs progress and completion status

